name: Semantic Versioning

on:
  push:
    branches:
      - main

permissions:
  contents: write

env:
  # -----------------------------------------------------------------
  # CONFIGURATION
  # -----------------------------------------------------------------
  # Path to your version file. Leave empty to skip file updates.
  VERSION_FILE: "./lib/config/version.ts" 
  # -----------------------------------------------------------------

jobs:
  release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 1. Calculate the new version
      - name: Calculate Next Version
        id: version
        uses: paulhatch/semantic-version@v5.4.0
        with:
          tag_prefix: "v"
          # MAJOR: Triggered by "feat!" or "BREAKING CHANGE"
          major_pattern: "(feat!|BREAKING CHANGE)"
          # MINOR: Triggered by "feat" OR your custom "fix!" rule
          minor_pattern: "(feat|fix!)"
          # PATCH: Triggered by standard fix, docs, chore, etc.
          patch_pattern: "(fix|docs|chore|perf|test)"
          version_format: "${major}.${minor}.${patch}"

      # 2. Update the Version File (Only runs if a new version is created)
      - name: Update Version File
        if: steps.version.outputs.version_created == 'true' && env.VERSION_FILE != ''
        run: |
          NEW_VERSION="${{ steps.version.outputs.version_tag }}"
          
          # Read the current first line to log the "Before" state
          CURRENT_LINE=$(head -n 1 "$VERSION_FILE")
          
          echo "-----------------------------------------------------"
          echo "Processing File: $VERSION_FILE"
          echo "Old Version Line: $CURRENT_LINE"
          echo "New Version Tag : $NEW_VERSION"
          echo "-----------------------------------------------------"
          
          # Use sed to replace the version string on the FIRST line only.
          # Regex matches quotes containing v? + numbers + dots
          sed -E -i "1s/(['\"])v?[0-9]+\.[0-9]+\.[0-9]+(['\"])/\1$NEW_VERSION\2/" "$VERSION_FILE"
          
          # Verify and log the "After" state
          NEW_LINE=$(head -n 1 "$VERSION_FILE")
          echo "Updated Line    : $NEW_LINE"
          echo "-----------------------------------------------------"

      # 3. Commit, Push, and Tag
      - name: Commit & Push Changes
        if: steps.version.outputs.version_created == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # If the version file was modified, commit it
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "Committing version file update..."
            git add "$VERSION_FILE"
            git commit -m "chore(release): bump version to ${{ steps.version.outputs.version_tag }} [skip ci]"
            git push origin HEAD:main
          else
             echo "No changes to version file detected."
          fi

          # Create and push the tag
          echo "Creating git tag: ${{ steps.version.outputs.version_tag }}"
          git tag -a "${{ steps.version.outputs.version_tag }}" -m "Release ${{ steps.version.outputs.version_tag }}"
          git push origin "${{ steps.version.outputs.version_tag }}"

      - name: Summary
        run: |
          echo "Previous Version: ${{ steps.version.outputs.previous_version }}"
          echo "New Version: ${{ steps.version.outputs.version_tag }}"
